 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/.gitignore b/.gitignore
new file mode 100644
index 0000000000000000000000000000000000000000..d4d7e3f6142fc46cf3168c34008336bfa1607df2
--- /dev/null
+++ b/.gitignore
@@ -0,0 +1,3 @@
+node_modules
+dist
+*.log
diff --git a/mvp6/src/components/MappingEditor.tsx b/mvp6/src/components/MappingEditor.tsx
index 06fb55d79d8cf606542a688d475e835359add0ff..01d4ef1aaf24ac418d89ee6a57efecd1122252e2 100644
--- a/mvp6/src/components/MappingEditor.tsx
+++ b/mvp6/src/components/MappingEditor.tsx
@@ -1,198 +1,433 @@
 import React, { useMemo, useState } from 'react'
-import { Check, ChevronRight, Search, Wand2 } from 'lucide-react'
+import { AlertTriangle, Check, ChevronRight, Filter, MousePointer2, Search, Undo2, Wand2 } from 'lucide-react'
 import { useAppStore } from '../store/appStore'
 import { computeDream } from '../lib/dream/compute'
-import { DreamGroup, DreamLine } from '../lib/types'
+import { DreamLine, XeroPLSection } from '../lib/types'
 import { setLineMappings } from '../lib/dream/edit'
+import { flattenLines } from '../lib/dream/schema'
 import { Button, Card, Chip, Input, Label } from './ui'
 
-function flattenLines(node: DreamGroup, out: DreamLine[] = []) {
-  for (const child of node.children) {
-    if (child.kind === 'line') out.push(child)
-    else flattenLines(child, out)
-  }
-  return out
-}
+type AccountRow = { name: string; section: XeroPLSection }
 
-function scoreSuggestion(lineLabel: string, accountName: string) {
-  const a = accountName.toLowerCase()
-  const l = lineLabel.toLowerCase()
-  let score = 0
-  for (const token of l.split(/[^a-z0-9]+/g).filter(Boolean)) {
-    if (token.length < 3) continue
-    if (a.includes(token)) score += 2
-  }
-  if (a.includes(l)) score += 5
-  if (l.includes('rent') && a.includes('rent')) score += 5
-  if (l.includes('insurance') && a.includes('insurance')) score += 5
-  return score
+const SECTION_LABEL: Record<XeroPLSection, string> = {
+  trading_income: 'Revenue',
+  other_income: 'Revenue',
+  cost_of_sales: 'COGS',
+  operating_expenses: 'OpEx',
+  unknown: 'Other',
 }
 
+const sectionFilterDefs = [
+  { id: 'unmapped', label: 'Unmapped only' },
+  { id: 'all', label: 'All accounts' },
+  { id: 'revenue', label: 'Revenue' },
+  { id: 'expense', label: 'Expenses' },
+] as const
+
 export function MappingEditor() {
   const pl = useAppStore(s => s.pl)
   const template = useAppStore(s => s.template)
   const setTemplate = useAppStore(s => s.setTemplate)
+  const undoTemplate = useAppStore(s => s.undoTemplate)
+  const canUndo = useAppStore(s => s.canUndo())
+  const lastTemplateSavedAt = useAppStore(s => s.lastTemplateSavedAt)
 
   const [selectedLineId, setSelectedLineIdLocal] = useState<string | null>(null)
   const [qLine, setQLine] = useState('')
   const [qAcc, setQAcc] = useState('')
+  const [accountFilter, setAccountFilter] = useState<(typeof sectionFilterDefs)[number]['id']>('unmapped')
+  const [matcher, setMatcher] = useState('')
+  const [excludeMatcher, setExcludeMatcher] = useState('')
+  const [draggingAcc, setDraggingAcc] = useState<string | null>(null)
+  const [hoverLineId, setHoverLineId] = useState<string | null>(null)
 
   const lines = useMemo(() => flattenLines(template.root), [template])
   const computed = useMemo(() => (pl ? computeDream(pl, template) : null), [pl, template])
 
   const selectedLine = useMemo(() => lines.find(l => l.id === selectedLineId) ?? null, [lines, selectedLineId])
-  const accountNames = useMemo(() => (pl ? pl.accounts.map(a => a.name).sort((a, b) => a.localeCompare(b)) : []), [pl])
+
+  const accounts = useMemo<AccountRow[]>(() => {
+    if (!pl) return []
+    return [...pl.accounts]
+      .map(a => ({ name: a.name, section: a.section }))
+      .sort((a, b) => a.name.localeCompare(b.name))
+  }, [pl])
 
   const mappedSet = useMemo(() => {
     const s = new Set<string>()
     for (const ln of lines) for (const a of ln.mappedAccounts) s.add(a)
     return s
   }, [lines])
 
-  const unmappedAccounts = useMemo(() => accountNames.filter(a => !mappedSet.has(a)), [accountNames, mappedSet])
+  const unmappedAccounts = useMemo(() => accounts.filter(a => !mappedSet.has(a.name)), [accounts, mappedSet])
+
+  const sectionStats = useMemo(() => {
+    const bucket = {
+      revenue: accounts.filter(a => a.section === 'trading_income' || a.section === 'other_income'),
+      cogs: accounts.filter(a => a.section === 'cost_of_sales'),
+      opex: accounts.filter(a => a.section === 'operating_expenses'),
+    }
+    return [
+      { id: 'revenue', label: 'Revenue', total: bucket.revenue.length, mapped: bucket.revenue.filter(a => mappedSet.has(a.name)).length },
+      { id: 'cogs', label: 'Cost of Sales', total: bucket.cogs.length, mapped: bucket.cogs.filter(a => mappedSet.has(a.name)).length },
+      { id: 'opex', label: 'OpEx', total: bucket.opex.length, mapped: bucket.opex.filter(a => mappedSet.has(a.name)).length },
+    ].map(s => ({ ...s, percent: s.total ? Math.round((s.mapped / s.total) * 100) : 0 }))
+  }, [accounts, mappedSet])
 
   const filteredLines = useMemo(() => {
     const needle = qLine.toLowerCase()
     return lines.filter(l => !needle || l.label.toLowerCase().includes(needle))
   }, [lines, qLine])
 
+  const includeRegex = useMemo(() => {
+    if (!matcher.trim()) return null
+    try {
+      return new RegExp(matcher, 'i')
+    } catch {
+      return null
+    }
+  }, [matcher])
+
+  const excludeRegex = useMemo(() => {
+    if (!excludeMatcher.trim()) return null
+    try {
+      return new RegExp(excludeMatcher, 'i')
+    } catch {
+      return null
+    }
+  }, [excludeMatcher])
+
   const filteredAccounts = useMemo(() => {
     const needle = qAcc.toLowerCase()
-    const list = (needle ? accountNames.filter(a => a.toLowerCase().includes(needle)) : unmappedAccounts)
-    return list.slice(0, 200)
-  }, [accountNames, unmappedAccounts, qAcc])
+    return accounts
+      .filter(a => {
+        if (accountFilter === 'unmapped') return !mappedSet.has(a.name)
+        if (accountFilter === 'revenue') return a.section === 'trading_income' || a.section === 'other_income'
+        if (accountFilter === 'expense') return a.section === 'cost_of_sales' || a.section === 'operating_expenses'
+        return true
+      })
+      .filter(a => !needle || a.name.toLowerCase().includes(needle))
+  }, [accounts, qAcc, accountFilter, mappedSet])
+
+  const matcherPreview = useMemo(() => {
+    if (!includeRegex) return { matches: [] as AccountRow[], excluded: [] as AccountRow[] }
+    const matches = accounts.filter(a => includeRegex.test(a.name))
+    const excluded = excludeRegex ? matches.filter(a => excludeRegex.test(a.name)) : []
+    const finalMatches = matches.filter(a => !excludeRegex || !excludeRegex.test(a.name))
+    return { matches: finalMatches, excluded }
+  }, [accounts, includeRegex, excludeRegex])
+
+  const matcherSet = useMemo(() => new Set(matcherPreview.matches.map(a => a.name)), [matcherPreview])
+  const excludedMatcherSet = useMemo(() => new Set(matcherPreview.excluded.map(a => a.name)), [matcherPreview])
 
   if (!pl) {
     return (
       <Card className="p-5">
         <div className="text-sm text-slate-300">Upload a Profit &amp; Loss export first.</div>
       </Card>
     )
   }
 
-  function toggleAccount(acc: string) {
-    if (!selectedLine) return
-    const existing = new Set(selectedLine.mappedAccounts)
+  function setMappings(line: DreamLine, mappedAccounts: string[]) {
+    setTemplate(setLineMappings(template, line.id, mappedAccounts), { preserveVersion: false })
+  }
+
+  function toggleAccount(line: DreamLine, acc: string) {
+    const existing = new Set(line.mappedAccounts)
     if (existing.has(acc)) existing.delete(acc)
     else existing.add(acc)
+    setMappings(line, Array.from(existing).sort((a, b) => a.localeCompare(b)))
+  }
 
-    setTemplate(setLineMappings(template, selectedLine.id, Array.from(existing).sort((a, b) => a.localeCompare(b))))
+  function mapAccountToLine(lineId: string, acc: string) {
+    const line = lines.find(l => l.id === lineId)
+    if (!line) return
+    if (line.mappedAccounts.includes(acc)) return
+    setMappings(line, [...line.mappedAccounts, acc])
+    setSelectedLineIdLocal(lineId)
+  }
+
+  function removeAccountFromLine(line: DreamLine, acc: string) {
+    if (!line.mappedAccounts.includes(acc)) return
+    setMappings(
+      line,
+      line.mappedAccounts
+        .filter(a => a !== acc)
+        .sort((a, b) => a.localeCompare(b))
+    )
   }
 
   function autoSuggest() {
     if (!selectedLine) return
     const scored = unmappedAccounts
-      .map(a => ({ a, s: scoreSuggestion(selectedLine.label, a) }))
+      .map(a => ({ a: a.name, s: scoreSuggestion(selectedLine.label, a.name) }))
       .filter(x => x.s > 0)
       .sort((x, y) => y.s - x.s)
       .slice(0, 10)
       .map(x => x.a)
     if (!scored.length) return
     const merged = Array.from(new Set([...selectedLine.mappedAccounts, ...scored]))
-    setTemplate(setLineMappings(template, selectedLine.id, merged))
+    setMappings(selectedLine, merged)
+  }
+
+  function applyMatcherToLine() {
+    if (!selectedLine || matcherPreview.matches.length === 0) return
+    const merged = Array.from(new Set([...selectedLine.mappedAccounts, ...matcherPreview.matches.map(m => m.name)]))
+    setMappings(selectedLine, merged)
+  }
+
+  function handleDropOnLine(e: React.DragEvent, lineId: string) {
+    e.preventDefault()
+    const acc = draggingAcc || e.dataTransfer.getData('text/plain')
+    if (!acc) return
+    mapAccountToLine(lineId, acc)
+    setHoverLineId(null)
+  }
+
+  function handleUnassignDrop(e: React.DragEvent) {
+    if (!selectedLine) return
+    e.preventDefault()
+    const acc = draggingAcc || e.dataTransfer.getData('text/plain')
+    if (!acc) return
+    removeAccountFromLine(selectedLine, acc)
   }
 
+  const autosaveLabel = lastTemplateSavedAt
+    ? `Autosaved ${new Date(lastTemplateSavedAt).toLocaleTimeString()}`
+    : 'Autosave ready'
+
   return (
     <Card className="p-5 overflow-hidden">
       <div className="flex items-start justify-between gap-4">
         <div>
           <div className="text-lg font-semibold">Mapping editor</div>
           <div className="text-sm text-slate-300">
-            Assign Xero accounts to Dream lines. Unmapped accounts are highlighted by default (so you can mop them up fast).
+            Drag/drop accounts between the panels or tap to toggle. Filters, matcher previews, and quick undo keep you fast.
           </div>
         </div>
-        <Chip>{unmappedAccounts.length} unmapped accounts</Chip>
+        <div className="flex items-center gap-2">
+          <Chip>{unmappedAccounts.length} unmapped</Chip>
+          <Chip tone="good">{autosaveLabel}</Chip>
+          <Button variant="ghost" disabled={!canUndo} onClick={() => undoTemplate()}>
+            <Undo2 className="h-4 w-4" /> Undo
+          </Button>
+        </div>
+      </div>
+
+      <div className="mt-4 grid grid-cols-1 gap-3 md:grid-cols-3">
+        {sectionStats.map(s => (
+          <div key={s.id} className="rounded-xl border border-white/10 bg-white/5 p-3">
+            <div className="flex items-center justify-between text-xs text-slate-300">
+              <span>{s.label} coverage</span>
+              <span>{s.mapped}/{s.total}</span>
+            </div>
+            <div className="mt-1 h-2 rounded-full bg-black/30 overflow-hidden">
+              <div className="h-full bg-indigo-400/80" style={{ width: `${s.percent}%` }} />
+            </div>
+            <div className="mt-1 text-xs text-slate-400">{s.percent}% mapped</div>
+          </div>
+        ))}
       </div>
 
-      <div className="mt-5 grid grid-cols-1 gap-4 md:grid-cols-[380px,1fr]">
+      <div className="mt-5 grid grid-cols-1 gap-4 md:grid-cols-[420px,1fr]">
         {/* Left: Dream lines */}
         <div className="rounded-2xl border border-white/10 bg-white/5 p-4 overflow-hidden">
           <div className="flex items-center gap-2">
             <Search className="h-4 w-4 text-slate-300" />
             <Input value={qLine} onChange={e => setQLine(e.target.value)} placeholder="Search Dream lines…" />
           </div>
 
           <div className="mt-3 max-h-[520px] overflow-auto pr-1">
             {filteredLines.map(l => (
               <div
                 key={l.id}
-                className={`flex items-center justify-between rounded-xl px-3 py-2 text-sm cursor-pointer border ${
-                  selectedLineId === l.id ? 'bg-indigo-500/15 border-indigo-400/30' : 'bg-transparent border-white/0 hover:bg-white/5 hover:border-white/10'
+                className={`flex items-center justify-between rounded-xl px-3 py-2 text-sm cursor-pointer border transition ${
+                  selectedLineId === l.id
+                    ? 'bg-indigo-500/15 border-indigo-400/30'
+                    : hoverLineId === l.id
+                      ? 'bg-indigo-500/10 border-indigo-400/20'
+                      : 'bg-transparent border-white/0 hover:bg-white/5 hover:border-white/10'
                 }`}
                 onClick={() => setSelectedLineIdLocal(l.id)}
+                onDragOver={e => {
+                  e.preventDefault()
+                  setHoverLineId(l.id)
+                }}
+                onDragLeave={() => setHoverLineId(null)}
+                onDrop={e => handleDropOnLine(e, l.id)}
               >
                 <div className="min-w-0">
                   <div className="truncate font-semibold">{l.label}</div>
-                  <div className="text-xs text-slate-400">
+                  <div className="text-xs text-slate-400 flex items-center gap-2">
                     {l.mappedAccounts.length ? `${l.mappedAccounts.length} mapped` : 'Unmapped'}
+                    {selectedLineId === l.id && draggingAcc && <span className="text-indigo-200">Release to map</span>}
                   </div>
                 </div>
                 <ChevronRight className="h-4 w-4 text-slate-400" />
               </div>
             ))}
           </div>
         </div>
 
-        {/* Right: Accounts picker */}
-        <div className="rounded-2xl border border-white/10 bg-white/5 p-4 overflow-hidden">
-          {!selectedLine ? (
-            <div className="text-sm text-slate-300">Select a Dream line to map accounts.</div>
-          ) : (
-            <>
-              <div className="flex items-start justify-between gap-3">
-                <div>
-                  <div className="text-base font-semibold">{selectedLine.label}</div>
-                  <div className="text-xs text-slate-400">Tap accounts to toggle. Think “photo editing”: fast, reversible, obvious.</div>
+        {/* Right: Accounts + matcher */}
+        <div className="space-y-4">
+          <div className="rounded-2xl border border-white/10 bg-white/5 p-4 overflow-hidden">
+            {!selectedLine ? (
+              <div className="text-sm text-slate-300">Select a Dream line to map accounts.</div>
+            ) : (
+              <>
+                <div className="flex items-start justify-between gap-3">
+                  <div>
+                    <div className="text-base font-semibold">{selectedLine.label}</div>
+                    <div className="text-xs text-slate-400">Drop accounts here or click to toggle.</div>
+                  </div>
+                  <Button variant="ghost" onClick={autoSuggest}>
+                    <Wand2 className="h-4 w-4" /> Suggest
+                  </Button>
                 </div>
-                <Button variant="ghost" onClick={autoSuggest}>
-                  <Wand2 className="h-4 w-4" /> Suggest
-                </Button>
-              </div>
 
-              <div className="mt-3">
-                <Label>Mapped accounts</Label>
-                <div className="mt-2 flex flex-wrap gap-2">
-                  {selectedLine.mappedAccounts.length === 0 && <Chip>None yet</Chip>}
-                  {selectedLine.mappedAccounts.map(a => (
-                    <Chip
-                      key={a}
-                      className="cursor-pointer hover:bg-rose-500/10"
-                      title="Click to remove"
-                      onClick={() => toggleAccount(a)}
-                    >
-                      <Check className="h-3 w-3" /> {a}
-                    </Chip>
-                  ))}
+                <div className="mt-3">
+                  <Label>Mapped accounts</Label>
+                  <div
+                    className="mt-2 flex flex-wrap gap-2 min-h-[44px] rounded-xl border border-white/10 bg-black/20 px-2 py-2"
+                    onDragOver={e => e.preventDefault()}
+                    onDrop={handleUnassignDrop}
+                  >
+                    {selectedLine.mappedAccounts.length === 0 && <Chip>Drop accounts to map</Chip>}
+                    {selectedLine.mappedAccounts.map(a => (
+                      <Chip
+                        key={a}
+                        className="cursor-pointer hover:bg-rose-500/10"
+                        title="Click to remove"
+                        onClick={() => toggleAccount(selectedLine, a)}
+                        draggable
+                        onDragStart={e => {
+                          setDraggingAcc(a)
+                          e.dataTransfer.setData('text/plain', a)
+                        }}
+                        onDragEnd={() => setDraggingAcc(null)}
+                      >
+                        <Check className="h-3 w-3" /> {a}
+                      </Chip>
+                    ))}
+                  </div>
+                    <div className="mt-2 text-xs text-slate-400 flex items-center gap-2">
+                      <MousePointer2 className="h-3 w-3" />
+                      Drag a mapped chip outside this box to unassign quickly.
+                    </div>
                 </div>
-              </div>
 
-              <div className="mt-4 flex items-center gap-2">
+                <div className="mt-3 grid grid-cols-1 gap-3 md:grid-cols-2">
+                  <div>
+                    <Label>Matcher preview</Label>
+                    <Input value={matcher} onChange={e => setMatcher(e.target.value)} placeholder="Regex, e.g. rent|lease" />
+                    {!includeRegex && matcher.trim() && (
+                      <div className="mt-1 text-xs text-rose-300 flex items-center gap-1">
+                        <AlertTriangle className="h-3 w-3" /> Invalid matcher regex.
+                      </div>
+                    )}
+                  </div>
+                  <div>
+                    <Label>Exclude</Label>
+                    <Input value={excludeMatcher} onChange={e => setExcludeMatcher(e.target.value)} placeholder="Regex to exclude" />
+                  </div>
+                </div>
+                <div className="mt-2 flex flex-wrap items-center gap-2 text-xs text-slate-300">
+                  <Chip tone={matcherPreview.matches.length ? 'good' : 'neutral'}>
+                    {matcherPreview.matches.length} matched
+                  </Chip>
+                  {matcherPreview.excluded.length > 0 && <Chip tone="bad">{matcherPreview.excluded.length} excluded</Chip>}
+                  <Button
+                    variant="ghost"
+                    onClick={applyMatcherToLine}
+                    disabled={!selectedLine || matcherPreview.matches.length === 0 || !includeRegex}
+                  >
+                    <Filter className="h-4 w-4" /> Map matched
+                  </Button>
+                  {computed && (
+                    <span className="text-slate-400">
+                      Line total preview: {(computed.byLineId[selectedLine.id]?.reduce((a, b) => a + b, 0) ?? 0).toLocaleString(undefined, {
+                        maximumFractionDigits: 0,
+                      })}
+                    </span>
+                  )}
+                </div>
+              </>
+            )}
+          </div>
+
+          <div className="rounded-2xl border border-white/10 bg-white/5 p-4 overflow-hidden">
+            <div className="flex flex-wrap items-center gap-2">
+              {sectionFilterDefs.map(def => (
+                <Chip
+                  key={def.id}
+                  className={`cursor-pointer ${accountFilter === def.id ? 'bg-indigo-500/15 border-indigo-400/30' : ''}`}
+                  onClick={() => setAccountFilter(def.id)}
+                >
+                  {def.label}
+                </Chip>
+              ))}
+              <div className="flex items-center gap-2 ml-auto">
                 <Search className="h-4 w-4 text-slate-300" />
-                <Input value={qAcc} onChange={e => setQAcc(e.target.value)} placeholder="Search Xero accounts… (blank shows unmapped)" />
+                <Input
+                  value={qAcc}
+                  onChange={e => setQAcc(e.target.value)}
+                  placeholder="Search Xero accounts…"
+                  className="w-64"
+                />
               </div>
+            </div>
 
-              <div className="mt-3 max-h-[360px] overflow-auto pr-1">
-                {filteredAccounts.map(a => {
-                  const active = selectedLine.mappedAccounts.includes(a)
-                  return (
-                    <div
-                      key={a}
-                      className={`flex items-center justify-between rounded-xl px-3 py-2 text-sm cursor-pointer border ${
-                        active ? 'bg-indigo-500/15 border-indigo-400/30' : 'bg-transparent border-white/0 hover:bg-white/5 hover:border-white/10'
-                      }`}
-                      onClick={() => toggleAccount(a)}
-                    >
-                      <div className="truncate">{a}</div>
-                      {active && <Check className="h-4 w-4 text-indigo-200" />}
+            <div className="mt-3 max-h-[360px] overflow-auto pr-1">
+              {filteredAccounts.map(a => {
+                const active = selectedLine?.mappedAccounts.includes(a.name)
+                const matched = matcherSet.has(a.name)
+                const excluded = excludedMatcherSet.has(a.name)
+                return (
+                  <div
+                    key={a.name}
+                    draggable
+                    onDragStart={e => {
+                      setDraggingAcc(a.name)
+                      e.dataTransfer.setData('text/plain', a.name)
+                    }}
+                    onDragEnd={() => setDraggingAcc(null)}
+                    className={`flex items-center justify-between rounded-xl px-3 py-2 text-sm cursor-pointer border ${
+                      active
+                        ? 'bg-indigo-500/15 border-indigo-400/30'
+                        : matched
+                          ? 'bg-emerald-500/10 border-emerald-400/30'
+                          : 'bg-transparent border-white/0 hover:bg-white/5 hover:border-white/10'
+                    } ${excluded ? 'opacity-60' : ''}`}
+                    onClick={() => selectedLine && toggleAccount(selectedLine, a.name)}
+                  >
+                    <div className="truncate">
+                      <div className="font-semibold">{a.name}</div>
+                      <div className="text-xs text-slate-400">{SECTION_LABEL[a.section]}</div>
                     </div>
-                  )
-                })}
-                {filteredAccounts.length === 0 && <div className="text-sm text-slate-400">No accounts found.</div>}
-              </div>
-            </>
-          )}
+                    {active && <Check className="h-4 w-4 text-indigo-200" />}
+                  </div>
+                )
+              })}
+              {filteredAccounts.length === 0 && <div className="text-sm text-slate-400 mt-2">No accounts match this filter.</div>}
+            </div>
+          </div>
         </div>
       </div>
     </Card>
   )
 }
+
+function scoreSuggestion(lineLabel: string, accountName: string) {
+  const a = accountName.toLowerCase()
+  const l = lineLabel.toLowerCase()
+  let score = 0
+  for (const token of l.split(/[^a-z0-9]+/g).filter(Boolean)) {
+    if (token.length < 3) continue
+    if (a.includes(token)) score += 2
+  }
+  if (a.includes(l)) score += 5
+  if (l.includes('rent') && a.includes('rent')) score += 5
+  if (l.includes('insurance') && a.includes('insurance')) score += 5
+  return score
+}
diff --git a/mvp6/src/components/TemplateEditor.tsx b/mvp6/src/components/TemplateEditor.tsx
index d445ea8787c8f8d21ea8c8d40d807b0ef6b16e94..b540a1ae195de421bc76af3bbbaa73b9d5874ae8 100644
--- a/mvp6/src/components/TemplateEditor.tsx
+++ b/mvp6/src/components/TemplateEditor.tsx
@@ -1,231 +1,388 @@
-import React, { useMemo, useState } from 'react'
-import { Plus, Trash2, ArrowUp, ArrowDown, FolderPlus, Type, RotateCcw, Download, Upload } from 'lucide-react'
+import React, { useEffect, useMemo, useState } from 'react'
+import { AlertTriangle, ArrowDown, ArrowUp, Download, FolderPlus, Plus, RotateCcw, ShieldCheck, Type, Upload } from 'lucide-react'
 import { useAppStore } from '../store/appStore'
 import { DreamGroup, DreamLine } from '../lib/types'
-import { addGroup, addLine, moveChild, removeNode, updateNodeLabel } from '../lib/dream/edit'
+import { addGroup, addLine, findNode, findParent, moveChild, removeNode, setLineMappings, updateNodeLabel } from '../lib/dream/edit'
 import { Button, Card, Chip, Input, Label } from './ui'
-
-function isGroup(n: DreamGroup | DreamLine): n is DreamGroup {
-  return n.kind === 'group'
-}
-
-function findGroup(root: DreamGroup, id: string): DreamGroup | null {
-  if (root.id === id) return root
-  for (const child of root.children) {
-    if (child.kind === 'group') {
-      const hit = findGroup(child, id)
-      if (hit) return hit
-    }
-  }
-  return null
-}
+import { DREAM_TEMPLATE_SCHEMA, flattenLines, generateNodeId, validateTemplate } from '../lib/dream/schema'
+import { computeDream, computeDreamTotals } from '../lib/dream/compute'
 
 export function TemplateEditor() {
   const template = useAppStore(s => s.template)
   const setTemplate = useAppStore(s => s.setTemplate)
   const resetTemplate = useAppStore(s => s.resetTemplate)
+  const pl = useAppStore(s => s.pl)
+  const undoTemplate = useAppStore(s => s.undoTemplate)
+  const canUndo = useAppStore(s => s.canUndo())
+  const lastTemplateSavedAt = useAppStore(s => s.lastTemplateSavedAt)
 
-  const [selectedGroupId, setSelectedGroupId] = useState('rev')
-  const [selectedChildIdx, setSelectedChildIdx] = useState<number | null>(null)
+  const [selectedId, setSelectedId] = useState(template.root.id)
   const [rename, setRename] = useState('')
+  const [templateName, setTemplateName] = useState(template.name)
+  const [migrateTargetId, setMigrateTargetId] = useState<string | null>(null)
+  const [importMessage, setImportMessage] = useState<string | null>(null)
+
+  const lines = useMemo(() => flattenLines(template.root), [template])
+  const validationIssues = useMemo(() => validateTemplate(template), [template])
+
+  const selectedNode = useMemo(() => findNode(template.root, selectedId) ?? template.root, [template, selectedId])
+  const selectedParent = useMemo(() => findParent(template.root, selectedId), [template, selectedId])
 
-  const group = useMemo(() => findGroup(template.root, selectedGroupId), [template, selectedGroupId])
+  const computed = useMemo(() => (pl ? computeDream(pl, template) : null), [pl, template])
+  const totals = useMemo(() => (pl && computed ? computeDreamTotals(pl, template, computed) : null), [pl, computed, template])
 
-  const selectedNode = useMemo(() => {
-    if (!group) return null
-    if (selectedChildIdx == null) return group
-    return group.children[selectedChildIdx] ?? null
-  }, [group, selectedChildIdx])
+  useEffect(() => {
+    setTemplateName(template.name)
+  }, [template.name])
 
-  const jsonExport = useMemo(() => JSON.stringify(template, null, 2), [template])
+  useEffect(() => {
+    const fallback = lines.find(l => l.id !== selectedId)?.id ?? null
+    setMigrateTargetId(fallback)
+  }, [selectedId, lines])
+
+  const hasMappedDescendants = useMemo(() => {
+    if (selectedNode.kind === 'line') return selectedNode.mappedAccounts.length > 0
+    const descendants: DreamLine[] = []
+    flattenLines(selectedNode as DreamGroup, descendants)
+    return descendants.some(l => l.mappedAccounts.length > 0)
+  }, [selectedNode])
 
   function commitRename() {
-    if (!selectedNode) return
     const label = rename.trim()
     if (!label) return
     setTemplate(updateNodeLabel(template, selectedNode.id, label))
+    setRename('')
   }
 
-  function addNewLine() {
-    if (!group) return
-    const id = `line_${Date.now()}`
-    const ln: DreamLine = { id, kind: 'line', label: 'New line', mappedAccounts: [] }
-    setTemplate(addLine(template, group.id, ln))
+  function handleAddLine() {
+    const parentId = selectedNode.kind === 'group' ? selectedNode.id : selectedParent?.parent.id ?? template.root.id
+    const ln: DreamLine = { id: generateNodeId('line'), kind: 'line', label: 'New line', mappedAccounts: [] }
+    setTemplate(addLine(template, parentId, ln))
   }
 
-  function addNewGroup() {
-    if (!group) return
-    const id = `group_${Date.now()}`
-    const g: DreamGroup = { id, kind: 'group', label: 'New group', children: [] }
-    setTemplate(addGroup(template, group.id, g))
+  function handleAddGroup() {
+    const parentId = selectedNode.kind === 'group' ? selectedNode.id : selectedParent?.parent.id ?? template.root.id
+    const g: DreamGroup = { id: generateNodeId('group'), kind: 'group', label: 'New group', children: [] }
+    setTemplate(addGroup(template, parentId, g))
   }
 
   function move(dir: -1 | 1) {
-    if (!group || selectedChildIdx == null) return
-    const to = selectedChildIdx + dir
-    if (to < 0 || to >= group.children.length) return
-    setTemplate(moveChild(template, group.id, selectedChildIdx, to))
-    setSelectedChildIdx(to)
+    moveNode(selectedId, dir)
+  }
+
+  function moveNode(nodeId: string, dir: -1 | 1) {
+    const info = findParent(template.root, nodeId)
+    if (!info) return
+    const to = info.index + dir
+    if (to < 0 || to >= info.parent.children.length) return
+    setTemplate(moveChild(template, info.parent.id, info.index, to))
+    setSelectedId(nodeId)
   }
 
-  function del() {
-    if (!selectedNode) return
-    if (selectedNode.id === template.root.id) return
+  function deleteSelected() {
+    if (!selectedParent) return
+    if (selectedNode.kind === 'line' && selectedNode.mappedAccounts.length && migrateTargetId) {
+      const target = lines.find(l => l.id === migrateTargetId)
+      if (target) {
+        const merged = Array.from(new Set([...target.mappedAccounts, ...selectedNode.mappedAccounts]))
+        const withMappings = setLineMappings(template, target.id, merged)
+        setTemplate(removeNode(withMappings, selectedNode.id))
+        setSelectedId(target.id)
+        return
+      }
+    }
+
     setTemplate(removeNode(template, selectedNode.id))
-    setSelectedChildIdx(null)
+    setSelectedId(template.root.id)
   }
 
   async function importTemplateFile(file: File | null) {
     if (!file) return
     const txt = await file.text()
     try {
       const parsed = JSON.parse(txt)
-      setTemplate(parsed)
+      const issues = validateTemplate(parsed)
+      const errors = issues.filter(i => i.level === 'error')
+      if (errors.length) {
+        setImportMessage(errors.map(e => e.message).join(' '))
+        return
+      }
+      setTemplate(parsed, { preserveVersion: true })
+      setSelectedId(parsed.root?.id ?? template.root.id)
+      setImportMessage(issues.length ? issues.map(i => i.message).join(' ') : 'Imported successfully.')
     } catch (e) {
-      alert('Invalid JSON template.')
+      setImportMessage('Invalid JSON template.')
     }
   }
 
+  function renderTree(node: DreamGroup | DreamLine, depth = 0) {
+    const isSelected = node.id === selectedId
+    const mappedCount = node.kind === 'line' ? node.mappedAccounts.length : null
+    return (
+      <div key={node.id} className="space-y-1">
+        <div
+          className={`flex items-center justify-between rounded-xl px-3 py-2 border cursor-pointer ${
+            isSelected ? 'bg-indigo-500/15 border-indigo-400/30' : 'bg-transparent border-white/0 hover:bg-white/5 hover:border-white/10'
+          }`}
+          style={{ marginLeft: depth * 12 }}
+          onClick={() => {
+            setSelectedId(node.id)
+            setRename('')
+          }}
+          title={mappedCount ? `${mappedCount} mapped accounts` : undefined}
+        >
+          <div className="flex items-center gap-2 min-w-0">
+            <div className={`h-2 w-2 rounded-full ${node.kind === 'group' ? 'bg-indigo-300' : 'bg-white/70'}`} />
+            <div className="font-semibold truncate">{node.label}</div>
+            <Chip className="px-2">{node.kind === 'group' ? 'Group' : 'Line'}</Chip>
+            {mappedCount != null && mappedCount > 0 && <Chip tone="good" className="px-2">{mappedCount} mapped</Chip>}
+          </div>
+          <div className="flex items-center gap-2">
+            <ArrowUp
+              className={`h-4 w-4 ${isSelected ? 'text-slate-100' : 'text-slate-500'}`}
+              onClick={e => {
+                e.stopPropagation()
+                moveNode(node.id, -1)
+              }}
+            />
+            <ArrowDown
+              className={`h-4 w-4 ${isSelected ? 'text-slate-100' : 'text-slate-500'}`}
+              onClick={e => {
+                e.stopPropagation()
+                moveNode(node.id, 1)
+              }}
+            />
+          </div>
+        </div>
+        {node.kind === 'group' && node.children.map(child => renderTree(child, depth + 1))}
+      </div>
+    )
+  }
+
+  const blockingDelete =
+    selectedNode.kind === 'line' &&
+    selectedNode.mappedAccounts.length > 0 &&
+    (!migrateTargetId || migrateTargetId === selectedNode.id)
+
+  const metadataChipTone: 'good' | 'bad' =
+    template.schemaVersion === DREAM_TEMPLATE_SCHEMA ? 'good' : 'bad'
+
   return (
     <Card className="p-5 overflow-hidden">
       <div className="flex items-start justify-between gap-4">
         <div>
           <div className="text-lg font-semibold">Dream P&amp;L layout editor</div>
           <div className="text-sm text-slate-300">
-            Edit categories and line items like an iPhone editor: select, rename, move, add, delete. Mappings stay separate.
+            Edit categories and line items like a tree editor. Reorder, rename, add, and protect mapped lines with guided delete.
           </div>
         </div>
         <div className="flex items-center gap-2">
-          <Button variant="ghost" onClick={() => resetTemplate()}>
-            <RotateCcw className="h-4 w-4" /> Reset
+          <Chip tone={metadataChipTone}>
+            Schema {template.schemaVersion || 'unknown'} • v{template.version ?? 1}
+          </Chip>
+          <Chip tone="good">Autosaved {lastTemplateSavedAt ? new Date(lastTemplateSavedAt).toLocaleTimeString() : 'now'}</Chip>
+          <Button variant="ghost" onClick={() => undoTemplate()} disabled={!canUndo}>
+            <RotateCcw className="h-4 w-4" /> Undo
           </Button>
         </div>
       </div>
 
-      <div className="mt-5 grid grid-cols-1 gap-4 md:grid-cols-[420px,1fr]">
-        {/* Left: Structure */}
-        <div className="rounded-2xl border border-white/10 bg-white/5 p-4 overflow-hidden">
-          <Label>Top-level groups</Label>
-          <div className="mt-2 flex flex-wrap gap-2">
-            {template.root.children
-              .filter(isGroup)
-              .map(g => (
-                <Chip
-                  key={g.id}
-                  className={`cursor-pointer ${selectedGroupId === g.id ? 'bg-indigo-500/15 border-indigo-400/30' : ''}`}
-                  onClick={() => {
-                    setSelectedGroupId(g.id)
-                    setSelectedChildIdx(null)
-                    setRename('')
-                  }}
-                >
-                  {g.label}
-                </Chip>
+      {validationIssues.length > 0 && (
+        <div className="mt-3 rounded-xl border border-amber-400/30 bg-amber-500/10 p-3 text-sm text-amber-100 flex items-start gap-2">
+          <AlertTriangle className="h-4 w-4 mt-0.5" />
+          <div>
+            <div className="font-semibold">Validation</div>
+            <ul className="list-disc list-inside text-amber-100/90">
+              {validationIssues.map((i, idx) => (
+                <li key={idx}>
+                  <span className="uppercase text-[10px] px-2 py-0.5 rounded bg-white/10 mr-2">{i.level}</span>
+                  {i.message}
+                </li>
               ))}
+            </ul>
           </div>
+        </div>
+      )}
 
-          <div className="mt-4">
-            <Label>Items in selected group</Label>
-            <div className="mt-2 max-h-[520px] overflow-auto pr-1">
-              {!group ? (
-                <div className="text-sm text-slate-400">Group not found.</div>
-              ) : (
-                group.children.map((c, idx) => (
-                  <div
-                    key={c.id}
-                    className={`rounded-xl px-3 py-2 border cursor-pointer ${
-                      selectedChildIdx === idx ? 'bg-indigo-500/15 border-indigo-400/30' : 'bg-transparent border-white/0 hover:bg-white/5 hover:border-white/10'
-                    }`}
-                    onClick={() => {
-                      setSelectedChildIdx(idx)
-                      setRename('')
-                    }}
-                  >
-                    <div className="text-sm font-semibold">{c.label}</div>
-                    <div className="text-xs text-slate-400">{c.kind === 'group' ? 'Group' : 'Line'}</div>
-                  </div>
-                ))
-              )}
+      <div className="mt-5 grid grid-cols-1 gap-4 md:grid-cols-[420px,1fr]">
+        {/* Left: Tree */}
+        <div className="rounded-2xl border border-white/10 bg-white/5 p-4 overflow-hidden">
+          <div className="flex items-center justify-between">
+            <Label>Tree</Label>
+            <div className="flex items-center gap-2">
+              <Button variant="ghost" onClick={handleAddLine}>
+                <Plus className="h-4 w-4" /> Add line
+              </Button>
+              <Button variant="ghost" onClick={handleAddGroup}>
+                <FolderPlus className="h-4 w-4" /> Add group
+              </Button>
             </div>
           </div>
-
-          <div className="mt-4 flex flex-wrap gap-2">
-            <Button variant="ghost" onClick={addNewLine}>
-              <Plus className="h-4 w-4" /> Add line
-            </Button>
-            <Button variant="ghost" onClick={addNewGroup}>
-              <FolderPlus className="h-4 w-4" /> Add group
-            </Button>
-          </div>
+          <div className="mt-3 max-h-[520px] overflow-auto pr-1">{renderTree(template.root)}</div>
         </div>
 
         {/* Right: Controls */}
-        <div className="rounded-2xl border border-white/10 bg-white/5 p-4 overflow-hidden">
-          {!selectedNode ? (
-            <div className="text-sm text-slate-300">Select a group or item.</div>
-          ) : (
-            <>
-              <div className="flex items-start justify-between gap-3">
-                <div>
-                  <div className="text-base font-semibold">{selectedNode.label}</div>
-                  <div className="text-xs text-slate-400">{selectedNode.kind === 'group' ? 'Group' : 'Line item'}</div>
+        <div className="space-y-4">
+          <div className="rounded-2xl border border-white/10 bg-white/5 p-4 overflow-hidden">
+            {!selectedNode ? (
+              <div className="text-sm text-slate-300">Select a group or item.</div>
+            ) : (
+              <>
+                <div className="flex items-start justify-between gap-3">
+                  <div>
+                    <div className="text-base font-semibold">{selectedNode.label}</div>
+                    <div className="text-xs text-slate-400">{selectedNode.kind === 'group' ? 'Group' : 'Line item'}</div>
+                    {selectedNode.kind === 'line' && selectedNode.mappedAccounts.length > 0 && (
+                      <div className="mt-1 text-xs text-emerald-200 flex items-center gap-1">
+                        <ShieldCheck className="h-3 w-3" /> {selectedNode.mappedAccounts.length} mapped accounts protected
+                      </div>
+                    )}
+                    {selectedNode.kind === 'group' && hasMappedDescendants && (
+                      <div className="mt-1 text-xs text-emerald-200 flex items-center gap-1">
+                        <ShieldCheck className="h-3 w-3" /> Contains mapped lines
+                      </div>
+                    )}
+                  </div>
+                  <div className="flex items-center gap-2">
+                    <Button variant="ghost" onClick={() => move(-1)} disabled={!selectedParent}>
+                      <ArrowUp className="h-4 w-4" />
+                    </Button>
+                    <Button variant="ghost" onClick={() => move(1)} disabled={!selectedParent}>
+                      <ArrowDown className="h-4 w-4" />
+                    </Button>
+                    <Button variant="danger" onClick={deleteSelected} disabled={!selectedParent || blockingDelete}>
+                      Delete
+                    </Button>
+                  </div>
                 </div>
-                <div className="flex items-center gap-2">
-                  <Button variant="ghost" onClick={() => move(-1)} disabled={selectedChildIdx == null}>
-                    <ArrowUp className="h-4 w-4" />
-                  </Button>
-                  <Button variant="ghost" onClick={() => move(1)} disabled={selectedChildIdx == null}>
-                    <ArrowDown className="h-4 w-4" />
-                  </Button>
-                  <Button variant="danger" onClick={del} disabled={selectedNode.id === template.root.id}>
-                    <Trash2 className="h-4 w-4" />
-                  </Button>
+
+                <div className="mt-4">
+                  <Label>Rename</Label>
+                  <div className="mt-2 flex gap-2">
+                    <Input value={rename} onChange={e => setRename(e.target.value)} placeholder={selectedNode.label} />
+                    <Button variant="ghost" onClick={commitRename}>
+                      <Type className="h-4 w-4" /> Apply
+                    </Button>
+                  </div>
                 </div>
-              </div>
 
-              <div className="mt-4">
-                <Label>Rename</Label>
-                <div className="mt-2 flex gap-2">
-                  <Input value={rename} onChange={e => setRename(e.target.value)} placeholder={selectedNode.label} />
-                  <Button variant="ghost" onClick={commitRename}>
-                    <Type className="h-4 w-4" /> Apply
-                  </Button>
+                {selectedNode.kind === 'line' && selectedNode.mappedAccounts.length > 0 && (
+                  <div className="mt-4 rounded-xl border border-amber-400/30 bg-amber-500/5 p-3">
+                    <div className="text-xs text-amber-200 font-semibold flex items-center gap-2">
+                      <AlertTriangle className="h-3 w-3" /> Protect mapped accounts
+                    </div>
+                    <div className="mt-2 text-xs text-amber-100">
+                      Choose a destination line to migrate mapped accounts before deleting.
+                    </div>
+                    <div className="mt-2">
+                      <select
+                        className="w-full rounded-xl bg-white/5 border border-white/10 px-3 py-2 text-sm text-slate-100"
+                        value={migrateTargetId ?? ''}
+                        onChange={e => setMigrateTargetId(e.target.value || null)}
+                      >
+                        <option value="">Select destination</option>
+                        {lines
+                          .filter(l => l.id !== selectedNode.id)
+                          .map(l => (
+                            <option key={l.id} value={l.id}>
+                              {l.label}
+                            </option>
+                          ))}
+                      </select>
+                    </div>
+                    {blockingDelete && <div className="mt-2 text-xs text-rose-200">Select a destination to proceed.</div>}
+                  </div>
+                )}
+              </>
+            )}
+          </div>
+
+          <div className="rounded-2xl border border-white/10 bg-white/5 p-4 overflow-hidden">
+            <div className="grid grid-cols-1 gap-3 md:grid-cols-2">
+              <div>
+                <Label>Template name</Label>
+                <Input value={templateName} onChange={e => setTemplateName(e.target.value)} />
+                <Button
+                  className="mt-2"
+                  variant="ghost"
+                  onClick={() => templateName.trim() && setTemplate({ ...template, name: templateName.trim() })}
+                >
+                  Save name
+                </Button>
+              </div>
+              <div>
+                <Label>Metadata</Label>
+                <div className="mt-2 flex flex-wrap gap-2 text-xs text-slate-300">
+                  <Chip>Schema: {template.schemaVersion}</Chip>
+                  <Chip>Version: v{template.version}</Chip>
+                  <Chip>ID: {template.id}</Chip>
                 </div>
               </div>
+            </div>
 
-              <div className="mt-6">
-                <Label>Export / import template JSON</Label>
-                <div className="mt-2 flex flex-wrap gap-2">
-                  <Button
-                    variant="ghost"
-                    onClick={() => {
-                      const blob = new Blob([jsonExport], { type: 'application/json' })
-                      const url = URL.createObjectURL(blob)
-                      const a = document.createElement('a')
-                      a.href = url
-                      a.download = 'dream-template.json'
-                      a.click()
-                      URL.revokeObjectURL(url)
-                    }}
-                  >
-                    <Download className="h-4 w-4" /> Export
-                  </Button>
-
-                  <label className="inline-flex items-center gap-2 rounded-xl px-4 py-2 text-sm font-semibold bg-white/5 hover:bg-white/10 border border-white/10 cursor-pointer">
-                    <Upload className="h-4 w-4" /> Import
-                    <input type="file" accept="application/json" className="hidden" onChange={e => importTemplateFile(e.target.files?.[0] ?? null)} />
-                  </label>
-                </div>
-                <textarea
-                  readOnly
-                  value={jsonExport}
-                  className="mt-3 w-full h-64 rounded-xl bg-black/30 border border-white/10 px-3 py-2 text-xs text-slate-200 font-mono"
-                />
+            <div className="mt-4">
+              <Label>Export / import template JSON</Label>
+              <div className="mt-2 flex flex-wrap gap-2">
+                <Button
+                  variant="ghost"
+                  onClick={() => {
+                    const blob = new Blob([JSON.stringify(template, null, 2)], { type: 'application/json' })
+                    const url = URL.createObjectURL(blob)
+                    const a = document.createElement('a')
+                    a.href = url
+                    a.download = `dream-template-${template.version}.json`
+                    a.click()
+                    URL.revokeObjectURL(url)
+                  }}
+                >
+                  <Download className="h-4 w-4" /> Export
+                </Button>
+
+                <label className="inline-flex items-center gap-2 rounded-xl px-4 py-2 text-sm font-semibold bg-white/5 hover:bg-white/10 border border-white/10 cursor-pointer">
+                  <Upload className="h-4 w-4" /> Import
+                  <input type="file" accept="application/json" className="hidden" onChange={e => importTemplateFile(e.target.files?.[0] ?? null)} />
+                </label>
+                <Button variant="ghost" onClick={() => resetTemplate()}>
+                  <RotateCcw className="h-4 w-4" /> Reset
+                </Button>
               </div>
-            </>
-          )}
+              {importMessage && <div className="mt-2 text-xs text-slate-300">{importMessage}</div>}
+            </div>
+          </div>
         </div>
       </div>
+
+      <div className="mt-5 rounded-2xl border border-white/10 bg-white/5 p-4">
+        <div className="flex items-center justify-between">
+          <div>
+            <div className="text-base font-semibold">Management P&amp;L preview</div>
+            <div className="text-xs text-slate-400">Live totals from the current template. Upload P&amp;L to populate.</div>
+          </div>
+          <Chip>{pl ? 'Live' : 'Awaiting upload'}</Chip>
+        </div>
+
+        {totals ? (
+          <div className="mt-3 grid grid-cols-2 gap-3 md:grid-cols-4">
+            <PreviewStat label="12-mo Revenue" value={totals.revenue.reduce((a, b) => a + b, 0)} />
+            <PreviewStat label="12-mo COGS" value={totals.cogs.reduce((a, b) => a + b, 0)} />
+            <PreviewStat label="12-mo OpEx" value={totals.opex.reduce((a, b) => a + b, 0)} />
+            <PreviewStat label="12-mo Net" value={totals.net.reduce((a, b) => a + b, 0)} />
+          </div>
+        ) : (
+          <div className="mt-3 text-sm text-slate-400">Upload a Profit &amp; Loss export to preview totals.</div>
+        )}
+      </div>
     </Card>
   )
 }
+
+function PreviewStat({ label, value }: { label: string; value: number }) {
+  return (
+    <div className="rounded-xl border border-white/10 bg-black/20 p-3">
+      <div className="text-xs text-slate-300">{label}</div>
+      <div className="mt-1 text-lg font-semibold tabular-nums">
+        {value.toLocaleString('en-AU', { style: 'currency', currency: 'AUD', maximumFractionDigits: 0 })}
+      </div>
+    </div>
+  )
+}
diff --git a/mvp6/src/lib/dream/edit.ts b/mvp6/src/lib/dream/edit.ts
index 18fb3aae9e1e1234e468de4cda9ff4526919780c..ef312b418462fd4088c0a9fca720f46b8977dc80 100644
--- a/mvp6/src/lib/dream/edit.ts
+++ b/mvp6/src/lib/dream/edit.ts
@@ -1,43 +1,64 @@
 import { DreamGroup, DreamLine, DreamTemplate } from '../types'
-
-export function cloneTemplate(t: DreamTemplate): DreamTemplate {
-  return JSON.parse(JSON.stringify(t))
-}
+import { cloneTemplate } from './schema'
 
 export function findPath(root: DreamGroup, id: string, path: string[] = []): string[] | null {
   if (root.id === id) return path.concat(root.id)
   for (const child of root.children) {
     if (child.id === id) return path.concat(root.id, child.id)
     if (child.kind === 'group') {
       const hit = findPath(child, id, path.concat(root.id))
       if (hit) return hit
     }
   }
   return null
 }
 
+export function findNode(root: DreamGroup, id: string): DreamGroup | DreamLine | null {
+  if (root.id === id) return root
+  for (const child of root.children) {
+    if (child.id === id) return child
+    if (child.kind === 'group') {
+      const hit = findNode(child, id)
+      if (hit) return hit
+    }
+  }
+  return null
+}
+
+export function findParent(root: DreamGroup, id: string): { parent: DreamGroup; index: number } | null {
+  for (let i = 0; i < root.children.length; i++) {
+    const child = root.children[i]
+    if (child.id === id) return { parent: root, index: i }
+    if (child.kind === 'group') {
+      const hit = findParent(child, id)
+      if (hit) return hit
+    }
+  }
+  return null
+}
+
 export function updateNodeLabel(t: DreamTemplate, nodeId: string, label: string): DreamTemplate {
   const next = cloneTemplate(t)
   const walk = (g: DreamGroup) => {
     if (g.id === nodeId) g.label = label
     for (const c of g.children) {
       if (c.id === nodeId) c.label = label
       if (c.kind === 'group') walk(c)
     }
   }
   walk(next.root)
   return next
 }
 
 export function setLineMappings(t: DreamTemplate, lineId: string, mappedAccounts: string[]): DreamTemplate {
   const next = cloneTemplate(t)
   const walk = (g: DreamGroup) => {
     for (const c of g.children) {
       if (c.kind === 'line' && c.id === lineId) c.mappedAccounts = mappedAccounts
       if (c.kind === 'group') walk(c)
     }
   }
   walk(next.root)
   return next
 }
 
diff --git a/mvp6/src/lib/dream/schema.ts b/mvp6/src/lib/dream/schema.ts
new file mode 100644
index 0000000000000000000000000000000000000000..69e083727a025504e06a13505c15f8a7979db081
--- /dev/null
+++ b/mvp6/src/lib/dream/schema.ts
@@ -0,0 +1,74 @@
+import { DreamGroup, DreamLine, DreamTemplate, TemplateValidationIssue } from '../types'
+
+export const DREAM_TEMPLATE_SCHEMA = 'dream-template/v1'
+
+export function cloneTemplate(t: DreamTemplate): DreamTemplate {
+  return JSON.parse(JSON.stringify(t))
+}
+
+export function ensureTemplateMetadata(t: DreamTemplate, opts?: { preserveVersion?: boolean }): DreamTemplate {
+  const next = cloneTemplate(t)
+  next.schemaVersion = next.schemaVersion || DREAM_TEMPLATE_SCHEMA
+  const currentVersion = Number.isFinite(next.version) ? next.version : 1
+  next.version = opts?.preserveVersion ? currentVersion : currentVersion + 1
+  return next
+}
+
+export function collectNodeIds(root: DreamGroup): string[] {
+  const ids: string[] = []
+  const walk = (node: DreamGroup | DreamLine) => {
+    ids.push(node.id)
+    if (node.kind === 'group') {
+      node.children.forEach(walk)
+    }
+  }
+  walk(root)
+  return ids
+}
+
+export function validateTemplate(template: DreamTemplate): TemplateValidationIssue[] {
+  const issues: TemplateValidationIssue[] = []
+
+  if (!template.schemaVersion) {
+    issues.push({ level: 'warning', message: 'Missing schemaVersion; assuming latest.' })
+  } else if (template.schemaVersion !== DREAM_TEMPLATE_SCHEMA) {
+    issues.push({ level: 'warning', message: `Schema version mismatch (${template.schemaVersion}); expected ${DREAM_TEMPLATE_SCHEMA}.` })
+  }
+
+  if (!Number.isFinite(template.version)) {
+    issues.push({ level: 'warning', message: 'Template version is missing; will default to 1.' })
+  }
+
+  if (!template.root || template.root.kind !== 'group') {
+    issues.push({ level: 'error', message: 'Template root is missing or invalid.' })
+    return issues
+  }
+
+  const seen = new Set<string>()
+  const walk = (node: DreamGroup | DreamLine) => {
+    if (!node.id) {
+      issues.push({ level: 'error', message: `Node "${node.label}" is missing an id.` })
+    } else if (seen.has(node.id)) {
+      issues.push({ level: 'error', message: `Duplicate node id "${node.id}".` })
+    } else {
+      seen.add(node.id)
+    }
+
+    if (node.kind === 'group') node.children.forEach(walk)
+  }
+  walk(template.root)
+
+  return issues
+}
+
+export function flattenLines(node: DreamGroup, out: DreamLine[] = []): DreamLine[] {
+  for (const child of node.children) {
+    if (child.kind === 'line') out.push(child)
+    else flattenLines(child, out)
+  }
+  return out
+}
+
+export function generateNodeId(prefix: string) {
+  return `${prefix}_${Math.random().toString(36).slice(2, 8)}`
+}
diff --git a/mvp6/src/lib/dream/template.ts b/mvp6/src/lib/dream/template.ts
index b5f60912de0923d019b59b0ef52223c5a67dce05..781fe0a741ae39167f363f7b14c98b5e8a2194f4 100644
--- a/mvp6/src/lib/dream/template.ts
+++ b/mvp6/src/lib/dream/template.ts
@@ -1,51 +1,54 @@
 import { DreamGroup, DreamLine, DreamTemplate } from '../types'
+import { DREAM_TEMPLATE_SCHEMA } from './schema'
 
 const line = (id: string, label: string, mappedAccounts: string[] = []): DreamLine => ({
   id,
   label,
   kind: 'line',
   mappedAccounts,
 })
 
 const group = (id: string, label: string, children: (DreamGroup | DreamLine)[]): DreamGroup => ({
   id,
   label,
   kind: 'group',
   children,
 })
 
 /**
  * Built-in Dream P&L template (editable in-app).
  * This is based on the Dream P&L HTML you supplied, including:
  * - Board / Investor View
  * - Revenue / Cost of Sales / Operating Expenses
  * - Sub-groups (Payroll, Premises, Technology, etc.)
  */
 export const DEFAULT_DREAM_TEMPLATE: DreamTemplate = {
   id: 'dream_v1',
   name: 'Dream P&L (Board / Investor View)',
+  schemaVersion: DREAM_TEMPLATE_SCHEMA,
+  version: 1,
   root: group('root', 'Dream P&L', [
     group('rev', 'Revenue', [
       line('rev_cba', 'CBA - Program Revenue'),
       line('rev_tms', 'cgTMS - Program Revenue'),
       line('rev_adj', 'Adjunct Therapies - Revenue'),
       line('rev_consult', 'Non-TMS Consultations - Revenue'),
     ]),
     group('cogs', 'Cost of Sales', [
       group('cogs_cba', 'CBA Cost of Sales', [
         line('cogs_cba_doc', 'CBA - Doctor Consultations'),
         line('cogs_cba_qt', 'CBA - Neuroimaging Processing (Quicktome)'),
         line('cogs_cba_creyos', 'CBA - Cognitive Assessments (Creyos)'),
         line('cogs_cba_radio', 'Radiology Services (Patient Scans)'),
       ]),
       group('cogs_tms', 'cgTMS Cost of Sales', [
         line('cogs_tms_oversight', 'cgTMS - Medical Oversight & Reviews'),
         line('cogs_tms_cons', 'cgTMS - Treatment Consumables'),
         line('cogs_tms_img', 'cgTMS - Post-Treatment Imaging Processing'),
         line('cogs_tms_cog', 'cgTMS - Post-Treatment Cognitive Assessments'),
       ]),
       group('cogs_other', 'Adjunct & Other Direct Costs', [
         line('cogs_adj_ext', 'Adjunct Therapies - External Providers & Practitioners'),
         line('cogs_non_tms_doc', 'Non-TMS Doctor Consultations'),
       ]),
     ]),
diff --git a/mvp6/src/lib/types.ts b/mvp6/src/lib/types.ts
index d1c838a0018e8bed330818649246ba3e0b15c2ef..a714ff4b8e1a11fdcf63116994efd305e3c5df7b 100644
--- a/mvp6/src/lib/types.ts
+++ b/mvp6/src/lib/types.ts
@@ -33,53 +33,60 @@ export type GLTxn = {
 
 export type GL = {
   txns: GLTxn[]
 }
 
 export type DreamNodeId = string
 
 export type DreamLine = {
   id: DreamNodeId
   label: string
   kind: 'line'
   // if empty => computed line remains 0 until mapped
   mappedAccounts: string[]
 }
 
 export type DreamGroup = {
   id: DreamNodeId
   label: string
   kind: 'group'
   children: (DreamGroup | DreamLine)[]
 }
 
 export type DreamTemplate = {
   id: string
   name: string
+  schemaVersion: string
+  version: number
   root: DreamGroup
 }
 
+export type TemplateValidationIssue = {
+  level: 'error' | 'warning'
+  message: string
+}
+
 export type DreamComputed = {
   months: MonthKey[]
   monthLabels: string[]
   byLineId: Record<DreamNodeId, number[]>
   byAccountName: Record<string, number[]>
 }
 
 export type ScenarioInputs = {
   enabled: boolean
   legacyTmsAccountMatchers: string[] // regex-like strings
 
   // If consult revenue is folded into the bundle, remove it so we don't double-count.
   includeDoctorConsultsInBundle: boolean
   legacyConsultAccountMatchers: string[] // regex-like strings
 
   // Clinic state affects MRI defaults + suggested bundle prices
   state: 'NSW/QLD' | 'WA' | 'VIC'
 
   // Doctor service fee retained by clinic (global).
   // Example: 15% means doctor payout (actual cost) = 85% of the patient fee.
   doctorServiceFeePct: number
 
   // Core volumes (per month)
   cbaMonthlyCount: number
   programMonthlyCount: number
diff --git a/mvp6/src/store/appStore.ts b/mvp6/src/store/appStore.ts
index 24e54d5899aa8dbddbd5913e059f02edc6027790..aa686d48f8be996352d45d9f324bcfb90f52a30d 100644
--- a/mvp6/src/store/appStore.ts
+++ b/mvp6/src/store/appStore.ts
@@ -1,90 +1,142 @@
 import { create } from 'zustand'
 import { persist } from 'zustand/middleware'
 import { DEFAULT_DREAM_TEMPLATE } from '../lib/dream/template'
 import { GL, ScenarioInputs, XeroPL, DreamTemplate } from '../lib/types'
+import { ensureTemplateMetadata } from '../lib/dream/schema'
 
 export type View = 'overview' | 'legacy' | 'dream' | 'mapping' | 'scenario' | 'help' | 'settings' | 'exports' | 'reports'
 
 type AppState = {
   view: View
   setView: (v: View) => void
 
   pl: XeroPL | null
   setPL: (pl: XeroPL | null) => void
 
   gl: GL | null
   setGL: (gl: GL | null) => void
 
   template: DreamTemplate
-  setTemplate: (t: DreamTemplate) => void
+  setTemplate: (t: DreamTemplate, opts?: { skipHistory?: boolean; preserveVersion?: boolean }) => void
   resetTemplate: () => void
+  undoTemplate: () => void
+  redoTemplate: () => void
+  canUndo: () => boolean
+  canRedo: () => boolean
+  templateHistory: DreamTemplate[]
+  templateFuture: DreamTemplate[]
+  lastTemplateSavedAt: string | null
 
   selectedLineId: string | null
   setSelectedLineId: (id: string | null) => void
 
   scenario: ScenarioInputs
   setScenario: (s: Partial<ScenarioInputs>) => void
 
   defaults: {
     suggestedCbaPrice: Record<'NSW/QLD' | 'WA' | 'VIC', number>
     suggestedProgramPrice: Record<'NSW/QLD' | 'WA' | 'VIC', number>
     mriCostByState: Record<'NSW/QLD' | 'WA' | 'VIC', number>
     mriPatientByState: Record<'NSW/QLD' | 'WA' | 'VIC', number>
     doctorServiceFeePct: number
   }
   setDefaults: (d: Partial<AppState['defaults']>) => void
 
   snapshots: {
     id: string
     name: string
     createdAt: string
     scenario: ScenarioInputs
     template: DreamTemplate
     pl: XeroPL | null
     gl: GL | null
   }[]
   addSnapshot: (name: string) => void
   loadSnapshot: (id: string) => void
   deleteSnapshot: (id: string) => void
 }
 
 export const useAppStore = create<AppState>()(
   persist(
     (set, get) => ({
       view: 'overview',
       setView: (v) => set({ view: v }),
 
       pl: null,
       setPL: (pl) => set({ pl }),
 
       gl: null,
       setGL: (gl) => set({ gl }),
 
       template: DEFAULT_DREAM_TEMPLATE,
-      setTemplate: (t) => set({ template: t }),
-      resetTemplate: () => set({ template: DEFAULT_DREAM_TEMPLATE }),
+      templateHistory: [],
+      templateFuture: [],
+      lastTemplateSavedAt: null,
+      setTemplate: (t, opts) => {
+        set(state => {
+          const next = ensureTemplateMetadata(t, { preserveVersion: opts?.preserveVersion })
+          const history = opts?.skipHistory ? state.templateHistory : [state.template, ...state.templateHistory].slice(0, 20)
+          return {
+            template: next,
+            templateHistory: history,
+            templateFuture: [],
+            lastTemplateSavedAt: new Date().toISOString(),
+          }
+        })
+      },
+      resetTemplate: () =>
+        set(state => ({
+          templateHistory: [state.template, ...state.templateHistory].slice(0, 20),
+          templateFuture: [],
+          template: ensureTemplateMetadata(DEFAULT_DREAM_TEMPLATE, { preserveVersion: true }),
+          lastTemplateSavedAt: new Date().toISOString(),
+        })),
+      undoTemplate: () =>
+        set(state => {
+          if (!state.templateHistory.length) return state
+          const [prev, ...rest] = state.templateHistory
+          return {
+            template: prev,
+            templateHistory: rest,
+            templateFuture: [state.template, ...state.templateFuture].slice(0, 20),
+            lastTemplateSavedAt: new Date().toISOString(),
+          }
+        }),
+      redoTemplate: () =>
+        set(state => {
+          if (!state.templateFuture.length) return state
+          const [next, ...rest] = state.templateFuture
+          return {
+            template: next,
+            templateHistory: [state.template, ...state.templateHistory].slice(0, 20),
+            templateFuture: rest,
+            lastTemplateSavedAt: new Date().toISOString(),
+          }
+        }),
+      canUndo: () => get().templateHistory.length > 0,
+      canRedo: () => get().templateFuture.length > 0,
 
       selectedLineId: null,
       setSelectedLineId: (id) => set({ selectedLineId: id }),
 
       scenario: {
         enabled: false,
         legacyTmsAccountMatchers: ['tms', 'cgtms', 'rTMS', 'transcranial'],
         includeDoctorConsultsInBundle: false,
         legacyConsultAccountMatchers: ['consult', 'appointment', 'dr ', 'doctor'],
 
         state: 'NSW/QLD',
 
         doctorServiceFeePct: 15,
 
         // Volumes (per month)
         cbaMonthlyCount: 0,
         programMonthlyCount: 0,
 
         // Revenue (default to the current framework totals)
         cbaPrice: 1325,
         programPrice: 10960,
 
         // Cost treatment
         addBundleCostsToScenario: true,
 
@@ -153,74 +205,83 @@ export const useAppStore = create<AppState>()(
         mriPatientByState: { 'NSW/QLD': 400, WA: 770, VIC: 0 },
         doctorServiceFeePct: 15,
       },
       setDefaults: (d) => set({ defaults: { ...get().defaults, ...d } }),
 
       snapshots: [],
       addSnapshot: (name) => {
         const state = get()
         const snapshot = {
           id: crypto.randomUUID(),
           name,
           createdAt: new Date().toISOString(),
           scenario: state.scenario,
           template: state.template,
           pl: state.pl,
           gl: state.gl,
         }
         set({ snapshots: [snapshot, ...state.snapshots].slice(0, 20) })
       },
       loadSnapshot: (id) => {
         const state = get()
         const snap = state.snapshots.find(s => s.id === id)
         if (!snap) return
         set({
           scenario: snap.scenario,
-          template: snap.template,
+          template: ensureTemplateMetadata(snap.template, { preserveVersion: true }),
+          templateHistory: [],
+          templateFuture: [],
+          lastTemplateSavedAt: new Date().toISOString(),
           pl: snap.pl,
           gl: snap.gl,
         })
       },
       deleteSnapshot: (id) => {
         set({ snapshots: get().snapshots.filter(s => s.id !== id) })
       },
     }),
     {
       name: 'cingulum-dream-pnl',
       partialize: (state) => ({
         template: state.template,
+        templateHistory: state.templateHistory,
+        templateFuture: state.templateFuture,
+        lastTemplateSavedAt: state.lastTemplateSavedAt,
         scenario: state.scenario,
         defaults: state.defaults,
         snapshots: state.snapshots,
       }),
       // Keep backward compatibility when we add new scenario keys (avoid old persisted state wiping defaults)
       merge: (persisted: any, current) => {
         const defaults = current.scenario
         const incoming = persisted?.scenario ?? {}
 
         const sanitizeScenario = (src: any, fallback: typeof defaults): typeof defaults => {
           const result: any = { ...fallback }
           for (const [key, value] of Object.entries(src ?? {})) {
             if (value === undefined || value === null) continue
             if (typeof value === 'string' && value.trim() === '') continue
             if (Array.isArray(value)) {
               // For matcher arrays, keep defaults when the persisted array is empty
               result[key] = value.length ? value : (fallback as any)[key] ?? []
               continue
             }
             result[key] = value as any
           }
           return result as typeof defaults
         }
 
         return {
           ...current,
           ...persisted,
-          template: persisted?.template ?? current.template,
+          template: ensureTemplateMetadata(persisted?.template ?? current.template, { preserveVersion: true }),
+          templateHistory: (persisted?.templateHistory ?? []).slice(0, 20),
+          templateFuture: (persisted?.templateFuture ?? []).slice(0, 20),
+          lastTemplateSavedAt: persisted?.lastTemplateSavedAt ?? current.lastTemplateSavedAt,
           scenario: sanitizeScenario(incoming, defaults),
           defaults: persisted?.defaults ?? current.defaults,
           snapshots: persisted?.snapshots ?? current.snapshots,
         }
       },
     }
   )
 )
 
EOF
)
